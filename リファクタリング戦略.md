# リファクタリング戦略
## 基本方針
書籍『リファクタリング』で紹介されるような、小さなステップで段階的かつ安全な手順で進める。
なおかつ自動テストがないコードベースに対して、書籍『レガシーコード改善ガイド』紹介されるような、まず自動テストを可能とする接合部を安全に作れるような手順で進める。

また上記のような安全な手順を取っていることがわかるよう、通常業務よりも細かい粒度でコミットログを残していく。

## 目指す形
RxSwiftを用いたMVVMを目指す。
ViewとViewModelの間は
- View -> ViewModelのイベント通知はメソッド呼び出し
- ViewModel -> Viewの状態更新はRxSwiftを用いたバインディング

で行う。

## 進め方案
1. リバーシのゲームとしての判定・状態管理が`BoardView`に代表されるViewの表示状態と結合しているため、切り離していく。
    1. `ReversiGameRepository`を作成し、ゲームのセーブ/ロードを委譲する。
    1. `ViewController`に`var game: ReversiGame`を作成し、ゲームの進行に合わせて`game`の状態も追従するようにする。
    1. ゲームの判定・状態管理を`ReversiGame`に移す。
1. ゲーム全体の進行ロジックを`ViewModel`に移す。
   ※ここは開始時点であまり戦略が浮かんでいないけれど、なるべく小さなステップで安全に進める。

## 既知バグ
2つのバグを発見済みなので、まずリグレッションテストを自動テストで準備し、その次にバグを再現する自動テストを書き修正していく。

### ディスクを裏返す処理の順番が仕様と異なる
[README](README.md)内「ディスクのアニメーション」に記載されている仕様
> - 左上、上、右上、右、右下、下、左下、左の最大 8 列のディスクが裏返る可能性があるが、ここに列挙した順に、各列内のディスクを裏返す

とあるが、左下と左の順番が逆になっている。

#### 再現手順
通常のゲーム進行中で検証可能な盤面に至ることが難しいので省略。
左下と左の順番が、左が優先されていることだけであれば容易に検証可能。

#### テストケース
初期値
```
xxxxx---
xooox---
xo#ox---
xooox---
xxxxx---
--------
--------
--------
```
の`#`の位置に黒のディスクを置いた時
```
xxxxx---
x234x---
x915x---
x876x---
xxxxx---
--------
--------
--------
```
の順でディスクを置く・裏返すアニメーションが実行されることを期待する自動テストを作成する。

### 次にプレイヤーの有効な手が存在しない状態でゲームを開始すると進行不能となる
ゲーム中、次にプレイヤーの有効な手が存在しない場合アラートが表示される。
しかしゲーム開始時読み込んだファイルが、次にプレイヤーの有効な手が存在しない状態だと進行不能になる。
- プレイヤーモードが"Manual": どこにもディスクを置くことができず、ターンが相手プレイヤーにも渡らない。"Reset"ボタンを押すことができるのみ。
- プレイヤーモードが"Computer": クラッシュする。

#### 再現手順
有効な手が存在せずパスするアラートが表示されている最中にアプリを再起動する。

#### テストケース
初期値
```
ox------
--------
--------
--------
--------
--------
--------
--------
```
で黒のターンで開始すると、相手プレイヤーにターンが移ることを期待する自動テストを作成する。
